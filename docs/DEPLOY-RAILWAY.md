# Деплой на Railway

Один сервис: бэкенд (NestJS) отдаёт API и собранный фронтенд (Vite/React). Сборка из **корня репозитория**.

---

## 1. Настройка в Railway

- **Root Directory:** не указывать (корень репозитория)
- **Build Command:** `npm run build`
- **Start Command:** `npm run start`

Сборка: устанавливаются зависимости фронта и бэка, собирается фронт, собирается бэк, статика копируется в `backend/public`. Старт: запускается бэкенд (миграции + Nest), он отдаёт `/api/*` и статику SPA с одного домена.

---

## 2. Переменные окружения (Variables)

| Переменная     | Обязательно | Описание |
|----------------|-------------|----------|
| `DATABASE_URL` | Да          | URL PostgreSQL (Neon или Railway Postgres). Пример: `postgresql://user:pass@host/db?sslmode=require` |
| `JWT_SECRET`   | Да          | Секрет для подписи JWT |
| `PORT`         | Нет         | Railway подставляет сам |
| `NODE_ENV`     | Нет         | Для продакшена можно задать `production` |

`VITE_API_URL` и `CORS_ORIGIN` не нужны: фронт и API на одном домене.

---

## 3. Порядок деплоя

1. Создать БД (Neon или Railway Postgres), скопировать `DATABASE_URL`.
2. Создать один сервис из репозитория (Root Directory пустой).
3. В Variables задать `DATABASE_URL` и `JWT_SECRET`.
4. Деплой: Build = `npm run build`, Start = `npm run start`.

После деплоя приложение доступно по одному URL (например `https://your-app.railway.app`).

**Первый запуск: пользователь для входа.** Миграции создают таблицы, но не создают пользователей. Чтобы войти (admin@clinic.local), один раз выполните сид БД. Локально из папки проекта:
```bash
cd backend && npx prisma db seed
```
(нужен тот же `DATABASE_URL`, что и на Railway — можно временно задать в `.env` и запустить команду, либо в Railway использовать «Run Command» / одноразовый контейнер с `npx prisma db seed`.) Логин после сида: `admin@clinic.local` / `admin123`.

---

## 4. Локальный запуск (без изменений)

Два терминала:

```bash
# Терминал 1 — бэкенд
cd backend && npm install && npm run start:dev
```

```bash
# Терминал 2 — фронтенд
cd frontend && npm install && npm run dev
```

Или из корня: `npm run dev:backend` и `npm run dev:frontend` в разных терминалах.

Открыть http://localhost:3000 — прокси перенаправляет `/api` на бэкенд.

---

## 5. Не видно обновлений на Railway (старый интерфейс, нет нового меню)

Если пушите в `main`, но на сайте по-прежнему старая версия:

1. **Root Directory должен быть пустым.**  
   В Railway: ваш сервис → **Settings** → **Source** → **Root Directory**.  
   Поле должно быть **пустым** (не `backend`, не `frontend`). Иначе собирается только одна часть и обновления фронта не попадают в деплой.

2. **Проверьте репозиторий и ветку.**  
   Settings → Source: указан ли нужный репозиторий и ветка **main**? Деплой идёт только с той ветки, что выбрана там.

3. **Запустите новый деплой с очисткой кэша.**  
   Вкладка **Deployments** → у последнего деплоя три точки **⋮** → **Redeploy** → включите **Clear build cache** → Redeploy. Дождитесь окончания сборки.

4. **Убедитесь, что коммиты дошли до GitHub.**  
   На GitHub в репозитории проверьте, что последний коммит с изменениями (например, сайдбара) есть в ветке `main`. Если пушили в другую ветку — смержите в `main` или переключите в Railway ветку на нужную.
